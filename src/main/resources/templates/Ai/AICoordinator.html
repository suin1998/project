<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/css/AICoordinator.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
<header>
    <div class="logo">Logo</div>
    <nav>
        <a href="#" id="logout"></a>
        <a href="#" id="myPage"></a>
        <a href="#" id="Main"></a>
    </nav>
</header>
<div class="wrapper">

    <aside class="sidebar">
        <h2>AI Coordinator</h2>

        <section class="section">
            <h3>지역 / 날짜</h3>
            <div class="input-group">
                <label>지역</label>
                <button class="dropdown-btn" id="regionBtn">지역 선택</button>
                <div class="excel-file" style="display: none">
                    <input type="file" id="excel-file-input" accept=".xlsx, .xls, .csv">
                </div>
                <div class="dropdown-panel" id="regionDropdown">
                    <select id="sido">
                        <option value="">시/도 선택</option>
                    </select>

                    <select id="sigungu">
                        <option value="">시/군/구 선택</option>
                    </select>

                    <select id="dong">
                        <option value="">읍/면/동 선택</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>날짜</label>
                <button class="dropdown-btn" id="dateBtn">날짜 선택</button>
                <div class="dropdown-panel" id="calendarPanel">
                    <input type="date" id="datePicker"/>
                </div>
            </div>
            <div class="check-group" id="checkGroup" style="display: none">
                <button id="checkBtn" class="check-btn">확인</button>
            </div>
            <div class="weather-display" id="weatherDisplay">
                <p>날씨 정보를 확인하려면 지역과 날짜를 선택해주세요.</p>
            </div>
        </section>

        <section class="section">
            <h3>스타일</h3>

            <div class="tag-group">
                <p>패션 스타일 (최대 3개)</p>
                <div class="tags" id="fashionStyleTags">
                    <span class="tag">캐주얼</span>
                    <span class="tag">스트릿</span>
                    <span class="tag">클래식</span>
                    <span class="tag">미니멀</span>
                    <span class="tag">고프코어</span>
                    <span class="tag">스포티</span>
                    <span class="tag">걸리시</span>
                    <span class="tag">시크</span>
                    <span class="tag">프레피</span>
                    <span class="tag">로맨틱</span>
                    <span class="tag">미니멀</span>
                    <span class="tag">레트로</span>
                    <span class="tag">에스닉</span>
                    <span class="tag">시티보이</span>
                    <span class="tag">리조트</span>
                    <span class="tag">워크웨어</span>
                    <span class="tag">놈코디</span>
                    <span class="tag">페미닌</span>

                </div>
            </div>

            <div class="tag-group">
                <p>느낌/컨디션 (최대 3개)</p>
                <div class="tags" id="tempStyleTags">
                    <span class="tag">따뜻한</span>
                    <span class="tag">시원한</span>
                    <span class="tag">단정한</span>
                    <span class="tag">깔끔한</span>
                    <span class="tag">귀여운</span>
                    <span class="tag">화사한</span>
                    <span class="tag">격식있는</span>
                    <span class="tag">세련된</span>
                    <span class="tag">화려한</span>
                    <span class="tag">무난한</span>
                    <span class="tag">편안한</span>
                    <span class="tag">활동적인</span>
                </div>
            </div>
        </section>

        <section class="section">
            <h3>상황 (단일 선택)</h3>
            <div class="tags" id="situationTags">
                <span class="tag">일상</span>
                <span class="tag">운동</span>
                <span class="tag">등산</span>
                <span class="tag">서핑</span>
                <span class="tag">모임</span>
                <span class="tag">소개팅</span>
                <span class="tag">데이트</span>
                <span class="tag">관광지</span>
                <span class="tag">휴양지</span>
                <span class="tag">학교</span>
                <span class="tag">면접</span>
                <span class="tag">직장</span>
                <span class="tag">상견례</span>
                <span class="tag">결혼식</span>
                <span class="tag">파티</span>
                <span class="tag">쇼핑</span>
                <span class="tag">장례식</span>

            </div>
        </section>

        <section class="section">
            <h3>내 옷장</h3>

            <div class="upload-box">
                <label for="clothesInput">+ 옷 사진 업로드</label>
                <input type="file" id="clothesInput" accept="image/*" multiple/>
            </div>

            <button id="loadSavedBtn" class="load-btn">저장된 옷 불러오기</button>

            <div class="category-buttons" id="categoryButtons"></div>

            <div class="my-clothes-list" id="clothesList">
            </div>
        </section>

    </aside>

    <!-- AI 추천 영역 -->
    <main class="main">
        <h2>AI 코디 추천 미리보기</h2>

        <div class="result-box">
            <!-- AI 추천 결과 이미지/텍스트 표시 예정 -->
            <p>AI가 추천한 코디가 여기 나타납니다.</p>
        </div>

        <button class="submit-btn">AI 코디 요청하기</button>
    </main>

</div>
<script src = "https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src = "https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script>
    // =========================================================
    // Flatpickr 라이브러리 CDN 로드
    // =========================================================

    function loadFlatpickrScripts() {
        // Flatpickr 메인 JS
        const fpScript = document.createElement('script');
        fpScript.src = 'https://cdn.jsdelivr.net/npm/flatpickr';
        document.body.appendChild(fpScript);

        // 한국어 로케일 JS
        const koScript = document.createElement('script');
        koScript.src = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js';
        document.body.appendChild(koScript);
    }

    document.addEventListener("DOMContentLoaded", () => {

        loadFlatpickrScripts();

        /* ===============================
           1. 드롭다운(지역, 날짜) 토글
        =============================== */

        // 지역 선택 버튼, 지역 드롭다운 가져오기
        const regionBtn = document.getElementById("regionBtn");
        const regionDropdown = document.getElementById("regionDropdown");

        // 날짜 선택 버튼, 날짜 드롭다운 가져오기
        const dateBtn = document.getElementById("dateBtn");
        const calendarPanel = document.getElementById("calendarPanel");

        // 확인 버튼 가져오기
        const checkGroup = document.getElementById("checkGroup");
        const checkBtn = document.getElementById("checkBtn");

        // 날씨 정보 위치 가져오기
        const weatherDisplay = document.getElementById("weatherDisplay");

        // (선택한 지역과 날짜의 값, 현재는 값이 없으나 선택 후 값이 생김)
        let selectedRegion = { siDo: null, siGunGu: null, dong: null };
        let selectedDate = null;
        let formattedDate = null;
        let today = new Date();

        let tMax = null;
        let tMin = null;
        let pop = null;


        // 지역 드롭다운 토글
        regionBtn.addEventListener("click", () => {
            regionDropdown.style.display =
                regionDropdown.style.display === "block" ? "none" : "block";
        });

        // 날짜 드롭다운 토글 및 달력 새로고침
        dateBtn.addEventListener("click", () => {
            calendarPanel.style.display =
                calendarPanel.style.display === "block" ? "none" : "block";

            if (window.flatpickrInstance) {
                window.flatpickrInstance.redraw();
            }
        });

        window.flatpickrInstance = null;

        function initializeFlatpickr() {
            const today = new Date();
            const datePickerInput = document.getElementById("datePicker");

            // if (typeof flatpickr === 'undefined') {
            //     setTimeout(initializeFlatpickr, 100);
            //     return;
            // }

            window.flatpickrInstance = flatpickr(datePickerInput, {
                inline: true,

                minDate: "today",
                maxDate: today.fp_incr(10),
                dateFormat: "Y년 m월 d일",
                locale: 'ko',

                // 드롭다운 닫고 텍스트 위로 값이 나오게 하기
                onChange: function (selectedDates, dateStr, instance) {
                    selectedDate = dateStr;
                    dateBtn.textContent = selectedDate;
                    calendarPanel.style.display = "none";

                    togglecheckgroupbtn();
                }
            });
        }

        initializeFlatpickr();

        /* ===============================
           2. 시/도 - 시/군/구 - 읍/면/동 (엑셀 기반)
        =============================== */

        const sidoSelect = document.getElementById("sido");
        const sigunguSelect = document.getElementById("sigungu");
        const dongSelect = document.getElementById("dong");

        let excelData = [];

        fetch("/sub_file/Korea_area.xlsx")  // 여기에 실제 경로 넣기
            .then(response => response.arrayBuffer())
            .then(buffer => {
                const workbook = XLSX.read(buffer, {type: "array"});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                excelData = XLSX.utils.sheet_to_json(sheet);

                excelData = excelData.filter(row =>
                    row["시도"] &&
                    row["시군구"] &&
                    row["읍면동"]
                );

                populateSido();
            })
            .catch(err => console.error("엑셀 로드 실패:", err));

        //  시/도 채우기
        function populateSido() {
            const sidoList = [...new Set(excelData.map(row => row["시도"]))];
            sidoSelect.innerHTML = `<option value="">시/도 선택</option>`; // 기본 옵션 초기화

            sidoList.forEach(sido => {
                const option = document.createElement("option");
                option.value = sido;
                option.textContent = sido;
                sidoSelect.appendChild(option);
            });
        }

        //  시군구 채우기
        sidoSelect.addEventListener("change", () => {
            sigunguSelect.innerHTML = `<option value="">시/군/구 선택</option>`;
            dongSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;

            if (!sidoSelect.value) return;

            const filtered = excelData.filter(row => row["시도"] === sidoSelect.value);
            const sigunguList = [...new Set(filtered.map(row => row["시군구"]))];

            sigunguList.forEach(sg => {
                const option = document.createElement("option");
                option.value = sg;
                option.textContent = sg;
                sigunguSelect.appendChild(option);
            });
        });

        //  읍면동 채우기
        sigunguSelect.addEventListener("change", () => {
            dongSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;

            if (!sigunguSelect.value) return;

            const filtered = excelData.filter(
                row => row["시도"] === sidoSelect.value && row["시군구"] === sigunguSelect.value
            );

            const dongList = [...new Set(filtered.map(row => row["읍면동"]))];

            dongList.forEach(d => {
                const option = document.createElement("option");
                option.value = d;
                option.textContent = d;
                dongSelect.appendChild(option);
            });

        });

        // 드롭다운 닫고 텍스트 위로 값이 나오게 하기(지역 값)
        dongSelect.addEventListener("change", () => {
            selectedRegion = {
                siDo: sidoSelect.value,
                siGunGu: sigunguSelect.value,
                dong: dongSelect.value
            }
            regionBtn.textContent = `${selectedRegion.siDo} ${selectedRegion.siGunGu} ${selectedRegion.dong}`;

            regionDropdown.style.display = "none";
            togglecheckgroupbtn();
        });

        // 지역 값과 날짜 값 선택 시 확인 버튼 표시
        function togglecheckgroupbtn() {
            if(selectedDate && selectedDate) {
                checkGroup.style.display = "block";
            } else {
                checkGroup.style.display = "none";
            }
        }

        const API_URL = '/AI/weather';

        function displayWeatherResult(data) {
            let html = ``;

            if (data){
                tMax = data.tempMax;
                tMin = data.tempMin;
                pop = data.rainProbability;
                html += `
            <div class="weather-forecast short-term">
                <p>최저 기온: ${tMin}°C</p>
                <p>최고 기온: ${tMax}°C</p>
                <p>강수 확률: ${pop}%</p>
            </div>`;
            } else {
                html += '<p>해당 날짜에 유효한 날씨 데이터가 없습니다.</p>';
            }

            weatherDisplay.innerHTML = html;
        }

        async function fetchWeather() {

            const dateRegex = /(\d{4})년 (\d{1,2})월 (\d{1,2})일/;
            const match = selectedDate.match(dateRegex);

            if (match) {
                // match[1]=YYYY, match[2]=M(M), match[3]=D(D)
                const yyyy = match[1];
                // 월(MM)과 일(DD)을 2자리로 패딩 (예: 1월 -> 01)
                const mm = String(match[2]).padStart(2, '0');
                const dd = String(match[3]).padStart(2, '0');

                formattedDate = `${yyyy}-${mm}-${dd}`; // 최종 형식: "2025-12-01"
            } else {
                // 날짜 파싱 실패 시 에러 처리 또는 기본값 설정 (선택 사항)
                console.error("날짜 파싱 실패: 예상 형식과 다릅니다.", selectedDate);
                $weatherDisplay.innerHTML = '<p class="error">날짜 형식 변환에 실패했습니다.</p>';
                return;
            }
            // 1. 요청 URL 구성
            const params = new URLSearchParams({
                siDo: selectedRegion.siDo,
                siGunGu: selectedRegion.siGunGu,
                dong: selectedRegion.dong,
                inputDate: formattedDate
            });

            const fullUrl = `${API_URL}?${params.toString()}`;
            weatherDisplay.innerHTML = '<p>날씨 정보 조회 중...</p>';

            try {
                const response = await fetch(fullUrl);
                const data = await response.json();

                if (response.ok) {
                    // 200 OK
                    displayWeatherResult(data);
                } else {
                    // 4xx, 5xx 에러 처리
                    weatherDisplay.innerHTML = `<p class="error">조회 실패: ${data.message || 'API 호출에 실패했습니다.'}</p>`;
                    console.error('API Error Response:', data);
                }
            } catch (error) {
                weatherDisplay.innerHTML = `<p class="error">네트워크 오류 또는 JSON 파싱 오류</p>`;
                console.error('Fetch Error:', error);
            }
        }

        // 지역 값과 날씨 값 저장 및 출력
        checkBtn.addEventListener("click", fetchWeather);



        /* ===============================
           태그 클릭 (최대 3개)
        =============================== */
        function setupTagLimit(containerId, maxCount) {
            const container = document.getElementById(containerId);
            const tags = container.querySelectorAll(".tag");

            tags.forEach(tag => {
                tag.addEventListener("click", () => {
                    if (tag.classList.contains("active")) {
                        tag.classList.remove("active");
                    } else {
                        const selected = container.querySelectorAll(".active");
                        if (selected.length >= maxCount) return;
                        tag.classList.add("active");
                    }
                });
            });

        }

        setupTagLimit("fashionStyleTags", 3);
        setupTagLimit("tempStyleTags", 3);


        /* ===============================
           상황 태그 (1개만 선택)
        =============================== */
        const situationTags = document.querySelectorAll("#situationTags .tag");

        situationTags.forEach(tag => {
            tag.addEventListener("click", () => {
                if (tag.classList.contains("active")) {
                    tag.classList.remove("active");
                    return;
                }
                situationTags.forEach(t => t.classList.remove("active"));
                tag.classList.add("active");
            });
        });



        /* ===============================
           사진 업로드 → 썸네일 표시
        =============================== */
        const input = document.getElementById("clothesInput");
        const clothesList = document.getElementById("clothesList");

        input.addEventListener("change", () => {
            const files = Array.from(input.files);

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        });

        /* =====================================
            옷 카테고리 기능 (기존 코드 유지)
        ===================================== */

        let clothesData = [];
        const categories = ["티셔츠", "팬츠", "아우터", "원피스", "기타"];

        const categoryButtons = document.getElementById("categoryButtons");


        /* =====================================
            카테고리 버튼 생성
        ===================================== */
        function renderCategoryButtons() {
            categoryButtons.innerHTML = "";
            categories.forEach(cat => {
                const btn = document.createElement("button");
                btn.textContent = cat;
                btn.addEventListener("click", () => {
                    document.querySelectorAll("#categoryButtons button")
                        .forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");

                    renderClothes(cat);
                });
                categoryButtons.appendChild(btn);
            });
        }

        renderCategoryButtons();


        /* =====================================
            AI 자동분류 (간단한 파일명 기반)
        ===================================== */
        function autoCategory(fileName) {
            const lower = fileName.toLowerCase();

            if (lower.includes("shirt") || lower.includes("tee")) return "티셔츠";
            if (lower.includes("pants") || lower.includes("jean")) return "팬츠";
            if (lower.includes("jacket") || lower.includes("coat")) return "아우터";
            if (lower.includes("onepiece") || lower.includes("dress")) return "원피스";
            return "기타";
        }


        /* =====================================
            옷 업로드 시 자동 분류 및 데이터 저장
        ===================================== */

        input.addEventListener("change", () => {
            const files = Array.from(input.files);

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const category = autoCategory(file.name);

                    clothesData.push({
                        src: e.target.result,
                        category: category
                    });

                    // 데이터가 추가될 때마다 리스트를 다시 렌더링
                    renderClothes();
                };
                reader.readAsDataURL(file);
            });
        });


        /* =====================================
            저장된 샘플 불러오기 (샘플 파일이기 때문에 안에 sampleImages는 지워도 됩니다.)
        ===================================== */
        const loadSavedBtn = document.getElementById("loadSavedBtn");

        loadSavedBtn.addEventListener("click", () => {
            const sampleImages = [
                // {src: "/static/sample/tshirt1.jpg", category: "티셔츠"},
                // {src: "/static/sample/pants1.jpg", category: "팬츠"},
                // {src: "/static/sample/jacket1.jpg", category: "아우터"}
            ];

            clothesData = clothesData.concat(sampleImages);
            renderClothes();
        });


        /* =====================================
            옷 리스트 렌더링
        ===================================== */
        function renderClothes(filterCategory = null) {
            clothesList.innerHTML = "";

            const list = filterCategory
                ? clothesData.filter(c => c.category === filterCategory)
                : clothesData;

            list.forEach(c => {
                const img = document.createElement("img");
                img.src = c.src;
                clothesList.appendChild(img);
            });
        }

        function collectUserData(){
            const fashionTags = Array.from(document.querySelectorAll("#fashionStyleTags .tag.active"))
                .map(tag => tag.textContent.trim());
            const tempTags = Array.from(document.querySelectorAll("#tempStyleTags .tag.active"))
                .map(tag => tag.textContent.trim())
            const tpoTag = document.querySelector("#situationTags .tag.active")
            const year = today.getFullYear();
            const month = (today.getMonth()+1).toString().padStart(2,'0');
            const day = today.getDate.toString().padStart(2,"0");
            const localDate = `${year}-${month}-${day}`;


            return{
                selectedDate: formattedDate,
                nowDate: localDate,
                siDo: selectedRegion.siDo,
                siGunGu: selectedRegion.siGunGu,
                dong: selectedRegion.dong,

                fashionStyles: fashionTags,
                tempStyles: tempTags,
                tpo: tpoTag,
                tempMax: tMax,
                tempMin: tMin,
                pop: pop,
                // uploadedClothes: uploadedClothes

            }

        }


    });

</script>
</body>
</html>