<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€</title>
    <link rel="stylesheet" href="/css/userCommunity.css">
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
</head>
<body>
<header>
    <div class="logo"><a href="/">Fit Maker</a>
    </div>
    <div class="movementPage">
        <a href="/myCloset" onclick="return redirectToMyCloset()">My Closet</a>
        <a href="/AICoordinator" onclick="return redirectToAICoordinator()">AI Coordinator</a>
        <a href="/community">Community</a>
    </div>
<!--    <nav>-->
<!--        <div class="headerBtn">-->
<!--            <div id="authButtons" style="display: none;"><a href="/login">Login</a>-->
<!--                <a href="/join">Join</a></div>-->

<!--            <div id="logoutButtons" style="display: none;">-->
<!--                <a href="/logout" id="logoutLink">Logout</a>-->
<!--                &lt;!&ndash;                <button id="MyClosetButton">My Closet</button>&ndash;&gt;-->
<!--                <a href="/myPage" onclick="return redirectToMyPage()">My Page</a>-->
<!--            </div>-->
<!--        </div>-->
<!--    </nav>-->
    <nav>
        <div class="logoutButtons">
            <a href="/logout" id="logoutLink">Logout</a>
            <a href="/myPage" onclick="return redirectToMyPage()">My Page</a>
            <!--            <button id="MyClosetButton">My Closet</button>-->
        </div>
    </nav>
</header>

<!--<div class="layout">-->
<!--    <aside class="sidebar">-->
<!--        <button id="MainBtn">Main</button>-->
<!--        <button id="MyPageBtn">My Closet</button>-->
<!--        <button id="AICoordinatorBtn">AI Coordinator</button>-->
<!--        <div class="loginButton" style="display: none">-->
<!--            <button id="loginBtn">ë¡œê·¸ì¸</button>-->
<!--        </div>-->
<!--        <div class="logoutButton" style="display: none">-->
<!--            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>-->
<!--        </div>-->
<!--    </aside>-->

<div class="container">
    <div class="top-bar">
        <div class="filter-bar" id="filter-bar">
            <select id="filter-list" class="filter-list">
                <option value="latest">ìµœì‹ ìˆœ</option>
                <option value="recommend">ì¶”ì²œìˆœ</option>
                <option value="view">ì¡°íšŒìˆœ</option>
            </select>
        </div>
        <div class="myBoardList">
            <button type="button" class="myBoard">ë‚´ ê¸€ ì¡°íšŒí•˜ê¸°</button>
        </div>
    </div>
    <!--            <button class="newPost-btn" id="newPost">ê¸€ì“°ê¸°</button>-->
    <div id="gallery" class="gallery">
    </div>

    <div class="pagination">
        <button class="page-btn" id="prev"> <</button>
        <div id="page-numbers"></div>
        <button class="page-btn" id="next"> ></button>
    </div>
</div>

<script>
    // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í›„ì— ì›ë˜ ê°€ë ¤ë˜ ê³³ìœ¼ë¡œ ê°ˆ ìˆ˜ ìˆê²Œ ì§€ì •í•˜ëŠ” ë³€ìˆ˜
    const REDIRECT_PARAM_NAME = 'redirectTo';
    // ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ í† í°
    // const accessToken = localStorage.getItem('accessToken');
    // const authButtons = document.getElementById('authButtons');
    // const logoutButtons = document.getElementById('logoutButtons');

    // ğŸ’¡ ì¶”ê°€: ì§€ì •ëœ ê²½ë¡œë¡œ ì´ë™ì„ ì‹œë„í•˜ë‹¤ê°€ ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
    function redirectToLogin(targetPath) {
        // ëª©í‘œ ê²½ë¡œ(ì˜ˆ: /AICoordinator)ë¥¼ ì¸ì½”ë”©í•˜ì—¬ redirectTo íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
        window.location.href = `/login?${REDIRECT_PARAM_NAME}=${encodeURIComponent(targetPath)}`;
        return false;
    }

    async function redirectToMyCloset() {
        const targetPath = '/myCloset';
        const isValid = await checkToken();
        if (!isValid) {
            return redirectToLogin(targetPath);
        } else {
            window.location.href = targetPath;
        }
        return false;
    }

    async function redirectToAICoordinator() {
        const targetPath = '/AICoordinator';
        const isValid = await checkToken();
        if (!isValid) {
            return redirectToLogin(targetPath);
        } else {
            window.location.href = targetPath;
        }
    }

    // í—¤ë” ë§ˆì´í´ë¡œì ¯ ë¡œê·¸ì•„ì›ƒ ì˜† ë¶€ë¶„ ë§ˆì´í˜ì´ì§€ë¡œ ë³€ê²½(ë‹¤ë¥¸ í˜ì´ì§€ë„ ë™ì¼)
    async function redirectToMyPage() {
        const targetPath = '/myPage';
        const isValid = await checkToken();
        if (!isValid) {
            return redirectToLogin(targetPath);
        } else {
            window.location.href = targetPath;
        }
    }

    // function redirectToMain() {
    //     window.location.href = '/';
    // }


    document.addEventListener('DOMContentLoaded', function () {
        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸
        // updateAuthButtons();

        // 2. ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', handleLogout);
        }

        const MyClosetButton = document.getElementById('MyClosetButton');
        if (MyClosetButton) {
            MyClosetButton.addEventListener('click', redirectToMyCloset);
        }

        // const logoMainButton = document.getElementById('logoMain');
        // if (logoMainButton) {
        //     logoMainButton.addEventListener('click', redirectToMain);
        // }

        const AICoordinatorButton = document.getElementById('AICoordinatorButton');
        if (AICoordinatorButton) {
            AICoordinatorButton.addEventListener('click', redirectToAICoordinator);
        }

        //ì¢‹ì•„ìš” ì‹«ì–´ìš” ë²„íŠ¼ ì´ë²¤íŠ¸
        const gallerylikeDislike = document.getElementById('gallery');
        if(gallerylikeDislike) {
            gallerylikeDislike.addEventListener('click', handleLikeDislike);
        }

        // ìµœì‹ ìˆœ, ì¡°íšŒìˆœ, ì¶”ì²œìˆœ ê´€ë ¨ í•„í„°
        // const filterList = document.getElementById('.filter-list');
        // filterList.addEventListener('change', function (){
        //     sortType = this.value;
        //     currentPage = 1;
        //     BoardList();
        // });

        checkToken();
    });

    async function checkToken() {
        // í† í° ê°€ì ¸ì˜¤ê¸°, í† í°ì´ ì—†ìœ¼ë©´ ë°˜í™˜
        const token = localStorage.getItem('accessToken');
        if(!token) return false;

        try {
            const checkApi = await fetch('/check/token' , {
                method: 'GET',
                headers: {
                    'Authorization' : `Bearer ${token}`
                }
            });
            // ì„œë²„ í† í°ì´ ìœ íš¨í•˜ë‹¤ë©´
            if (checkApi.ok) {
                return true;
                //ì„œë²„ í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šë‹¤ë©´
            } else if (checkApi.status === 401) {
                console.warn('í† í° ë¬´íš¨');
                localStorage.removeItem('accessToken');
                // localStorage.removeItem('refreshToken');
                // updateAuthButtons(); // ë¹„ë¡œê·¸ì¸ ìƒíƒœë¡œ ê°±ì‹ 
                return false;
            }
            return false;
        } catch (error) {
            console.error('í† í° ìœ íš¨ì„± ê²€ì‚¬ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ', error);
        }

    }

    // ========== ì¸ì¦ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜ ==========
    // function updateAuthButtons() {
    //
    //     if (accessToken) {
    //         // í† í°ì´ ì¡´ì¬í•˜ë©´ (ë¡œê·¸ì¸ ìƒíƒœ)
    //         if (authButtons) authButtons.style.display = 'none';
    //         if (logoutButtons) logoutButtons.style.display = 'flex'; // í˜¹ì€ block
    //     } else {
    //         // í† í°ì´ ì—†ìœ¼ë©´ (ë¹„ë¡œê·¸ì¸ ìƒíƒœ)
    //         if (authButtons) authButtons.style.display = 'flex'; // í˜¹ì€ block
    //         if (logoutButtons) logoutButtons.style.display = 'none';
    //     }
    // }

    // ========== ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜ ==========
    function handleLogout(event) {
        event.preventDefault(); // <a> íƒœê·¸ì˜ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ì´ë™) ë°©ì§€

        // 1. JWT í† í° ì œê±°
        localStorage.removeItem('accessToken');
        // localStorage.removeItem('refreshToken');

        // 2. ë²„íŠ¼ ìƒíƒœë¥¼ ë¹„ë¡œê·¸ì¸ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        // updateAuthButtons();

        // í˜„ì¬ í˜ì´ì§€ ë¦¬ë¡œë“œ
        // window.location.reload();
        window.location.href = '/';
    }

    // ê²Œì‹œê¸€ ë³´ì´ëŠ” í˜ì´ì§€ ê´€ë ¨
    const gallery = document.getElementById("gallery");
    const pageNumbers = document.getElementById("page-numbers");

    // ê²Œì‹œë¬¼ DB ê°€ì ¸ì˜¤ë©´ ì—¬ê¸°ë‹¤ê°€ ì—°ê²°ë¨
    let allPosts = [];

    // ê²Œì‹œë¬¼ ì„ íƒ ì •ë ¬ ê¸°ì¤€(ê¸°ë³¸ê°’: ìµœì‹ ìˆœ)
    let sortType = 'lastest';

    // ê²Œì‹œë¬¼ ì‹œì‘ ~ ë (ì´ 12ê°œ ì¶œë ¥)
    let currentPage = 1;
    const itemsPerPage = 12;

    let totalPages = 1; // í˜ì´ì§€ ìˆ˜(ì „ì—­ë³€ìˆ˜ ì„ ì–¸)

    //ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ ì´ë™
    function goDetail(id) {
        window.location.href = `/post/${id}`;
    }

    async function BoardList() {
        const token = localStorage.getItem('accessToken');

        try {
            const response = await fetch(`/community/post?size=${itemsPerPage}&page=${currentPage}&sort${sortType}`,
                {
                    method: 'GET',
                    headers: {
                        // í† í°ì´ ìˆì„ ê²½ìš°ì—ë§Œ í—¤ë” ìˆ˜ì •
                    ...(token && {'Authorization' : `Bearer ${token}`}),
                    'Content-Type' : `application/json`
                    }
                });
            if (!response.ok) {
                throw new Error(`ì¡°íšŒì‹¤íŒ¨ : ${response.status}`);
            }
            // ì¡°íšŒ ì„±ê³µì‹œ ë°ì´í„°(DTO) ë°›ê³  ì €ì¥
            const responseData = await response.json();
            allPosts = responseData.dtoList; // dtoList ì—°ê²°í•´ì•¼ DBì—°ê²° ê°€ëŠ¥
            totalPages = responseData.totalPages; // ì´ í˜ì´ì§€ ìˆ˜ ì €ì¥
            console.log('---ì¡°íšŒ ì™„ë£Œ---'); // í™•ì¸ìš© ì½˜ì†”, ì§€ì›Œë„ë¨

            currentPage = 1; // ìƒˆ ë°ì´í„° ë¡œë“œì‹œ 1í˜ì´ì§€ ì´ˆê¸°í™” ì‹œí‚´
            renderGallery(); // ê°¤ëŸ¬ë¦¬ ì¶œë ¥ ì—°ê²°
            renderPagination(); //í˜ì´ì§€ ë„˜ê¹€ ì¶œë ¥ ì—°ê²°

        } catch (error) {
            console.error('ëª©ë¡ ì¡°íšŒ ì¤‘ ì—ëŸ¬ ë°œìƒ', error);
            if (gallery) {
                gallery.innerHTML = `ê²Œì‹œë¬¼ ë¡œë“œ ì‹¤íŒ¨`;
            }
        }
    }

    // ê°¤ëŸ¬ë¦¬ ì¶œë ¥
    function renderGallery() {

        // ê²Œì‹œë¬¼ì´ ì—†ì„ ê²½ìš°
        if (!allPosts.length) {
            gallery.innerHTML = "<p>í‘œì‹œí•  ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤!</p>";
            return;
        }
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        const postsToRender = allPosts.slice(start, end);// í˜„ì¬ í˜ì´ì§€ ê²Œì‹œë¬¼ ëª©ë¡ ìŠ¬ë¼ì´ë“œ

        const galleryHTML = postsToRender.map(BoardListDTO => {
            const {
                id,
                userStyle,
                mainImageUrl,
                userNickname,
                regDate,
                viewCount,
                likeCount,
                isLiked = false, // ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ëŠ”ì§€ì— ëŒ€í•œ ìƒíƒœ (falseëŠ” ì„ì‹œ ìƒíƒœ, ì´í›„ DTOì¶”ê°€ í•´ì•¼í•œë‹¤í•¨)
                isDisliked = false, // ì‚¬ìš©ìê°€ ì‹«ì–´ìš”ë¥¼ ëˆŒë €ëŠ”ì§€ì— ëŒ€í•œ ìƒíƒœ (falseëŠ” ì„ì‹œ ìƒíƒœ, ì´í›„ DTOì¶”ê°€ í•´ì•¼í•œë‹¤í•¨)
                dislikeCount
            } = BoardListDTO;

            const likeClass = isLiked ? 'active' : '';
            const dislikeClass = isDisliked ? 'active' : '';

            return `
        <div class="gallery-item" data-post-id="${id}">
            <div class="img-box">
                <img src="${mainImageUrl || ''}" alt="">
                    <div class="overlay" onclick="goDetail(${id})">${userStyle || ''}</div>
            </div>
            <div class="gallery-check">
                <div class="username" style="display: none">${userNickname}</div>
                <div class="regDate" style="display: none">${regDate}</div>
                <div class="gallery-like">
                    <button type="button" class="likeBtn btn ${likeClass}" data-action="like">
                        <i class="fas fa-heart" id="likeHeart"></i> <span class="likeCount">${likeCount || 0}</span>
                    </button>
                    <button type="button" class="dislikeBtn btn${dislikeClass}" data-action="dislike">
                        <i class="fas fa-heart" id="dislikeHeart"></i> <span class="dislikeCount">${dislikeCount || 0}</span>
                    </button>
                </div>
                <div class="ViewsCount">
                    <p class="viewCount">${viewCount || 0}</p>
                </div>
            </div>
        </div>`;
        }).join('');
        gallery.innerHTML = galleryHTML;
    }

    function initializeBoard() {
        // ê²Œì‹œë¬¼ ëª©ë¡ ë¡œë“œ
        BoardList();
    }

    document.addEventListener('DOMContentLoaded', initializeBoard);

    // í˜ì´ì§€ ë²„íŠ¼ ì¶œë ¥
    function renderPagination() {
        pageNumbers.innerHTML = "";

        // í˜ì´ì§€ìˆ˜ ê²€ì‚¬(ì „ì—­ ë³€ìˆ˜)
        if (totalPages < 1) return;

        // í•œ í˜ì´ì§€ì— ë³´ì¼ ìµœëŒ€ í˜ì´ì§€ ìˆ«ì
        const groupSize = 10;
        const group = Math.floor((currentPage - 1) / groupSize);
        const start = group * groupSize + 1;
        const end = Math.min(start + groupSize - 1, totalPages);

        for (let i = start; i <= end; i++) {
            const span = document.createElement("span");
            span.textContent = i;
            if (i === currentPage) span.classList.add("active");

            span.onclick = () => {
                currentPage = i;
                renderEverything();
            };

            pageNumbers.appendChild(span);
        }
    }

    // prev / next ë²„íŠ¼
    document.getElementById("prev").onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderEverything()
        }
    };

    document.getElementById("next").onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderEverything();
        }
    };

    function renderEverything() {
        renderGallery();
        renderPagination();
    }

    // í—¤ë”ì˜ ë§ˆì´í´ë¡œì ¯ í´ë¦­ ì‹œ ë¡œê·¸ì¸ í™•ì¸ ì—¬ë¶€(ë¡œê·¸ì¸ í™•ì¸ì´ ë˜ì–´ìˆì§€ ì•Šì„ ì‹œ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™)
    // function checkLogin() {
    //     if (!accessToken) {
    //         window.location.href = '/login';
    //         return false;
    //     } else {
    //         return true;
    //     }
    // }
    // ì¢‹ì•„ìš” ì‹«ì–´ìš” í´ë¦­ ì‹œ, ì—…ë°ì´íŠ¸ newLikeCount ì™€ new DislikeCountëŠ” ë”°ë¡œ DTO ì¶”ê°€í•´ì•¼í•œë‹¤ í•¨.
    function updateLikeDislike(clickedButton, newLikeCount, newDislikeCount) {
        // ë¶€ëª¨ ì»¨í…Œì´ë„ˆ
        const galleyCheck = clickedButton.closest('.gallery-check');
        // ì¢‹ì•„ìš” ì‹«ì–´ìš” ë²„íŠ¼
        const likeBtn = galleyCheck.querySelector('.likeBtn');
        const dislikeBtn = galleyCheck.querySelector('.dislikeBtn');

        // í˜„ì¬ ìƒíƒœ íŒŒì•… (ë²„íŠ¼ì´ í˜„ì¬ í´ë¦­ëœ ìƒíƒœì¸ì§€)
        const isClicked = clickedButton.classList.contains('active');
        // í´ë¦­ëœ ë²„íŠ¼ì´ ì–´ë–¤ ê±´ì§€(likeì¸ì§€ dislikeì¸ì§€)
        const action = clickedButton.dataset.action;

        // ë‹¤ë¥¸ ìª½ì„ ëˆ„ë¥´ë©´ ë‹¤ë¥¸ ìª½ ë²„íŠ¼ í•´ì œ
        if (!isClicked){
            const oppositeBtn = action === 'like' ? dislikeBtn : likeBtn;

            //ë§Œì•½ ë‹¤ë¥¸ ìª½ ë²„íŠ¼ì´ í´ë¦­ëœ ìƒíƒœë¼ë©´ ê¸°ì¡´ í´ë¦­ëœ ê²ƒ ì œê±°í•˜ê¸°.
            if(oppositeBtn.classList.contains('active')) {
                oppositeBtn.classList.remove('active');
            }
        }
        clickedButton.classList.toggle('active'); // í´ë¦­ëœ ë²„íŠ¼ ë¹„í™œì„±í™”

        // ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë©´ ì¢‹ì•„ìš” ìˆ«ì ì¦ê°€, ì‹«ì–´ìš”ë¥¼ ëˆ„ë¥´ë©´ ì‹«ì–´ìš” ìˆ«ì ì¦ê°€
        likeBtn.querySelector('.likeCount').textContent = newLikeCount;
        dislikeBtn.querySelector('.dislikeCount').textContent = newDislikeCount;
    }

    // ì¢‹ì•„ìš” ì‹«ì–´ìš” ìš”ì²­
    async function handleLikeDislike(event) {
        const targetBtn = event.target.closest('.likeBtn, .dislikeBtn');
        // í´ë¦­ ì˜ì—­ì´ ì¢‹ì•„ìš”ë‚˜ ì‹«ì–´ìš”ê°€ ì•„ë‹ ê²½ìš°
        if(!targetBtn) return;

        const accessToken = localStorage.getItem('accessToken');

        // ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ìˆë‹¤ë©´ ë¡œê·¸ì¸í•˜ê¸°
        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }
        // ê²Œì‹œê¸€ id ì¶”ì¶œ
        const postId = targetBtn.closest('.gallery-item').dataset.postId;
        // ë²„íŠ¼ ì¢…ë¥˜ ì¶”ì¶œ
        const action = targetBtn.dataset.action;
        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ í™•ì¸
        const isActive = targetBtn.classList.contains('active');
        const actionType = isActive ? 'remove' : 'add';
        // ì„œë²„ë¡œ ë³´ë‚¼ ì—”ë“œurl (ë°±ì—”ë“œì™€ ì—°ê²°ì„ ìœ„í•œ ê²ƒ)
        const endpoint = `/community/post/${postId}/${action}/${actionType}`;

        try {
            const response = await fetch(endpoint, {
                method: 'POST', // ë°ì´í„° ë³€ê²½ì„ ìœ„í•œ ì„¤ì •
                headers: {'Authorization': `Bearer ${accessToken}`, // ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•œ ê²ƒ(í† í° ìœ í˜•ìœ¼ë¡œ accessTokenì„ ë´„)
                    'Content-Type' : `application/json` // ë³¸ë¬¸ì˜ ë‚´ìš©ì´ json í˜•ì‹ìœ¼ë¡œ ì„œë²„ì— ì•Œë¦¼(ì „ì†¡ ë°ì´í„° ìœ í˜• ì •í•˜ëŠ” ê²ƒ)
                },
            });
            //ì‘ë‹µ ì˜¤ë¥˜ì‹œ
            if(!response.ok) {
                throw new Error('ìš”ì²­ ì‹¤íŒ¨, ë˜ëŠ” ê¶Œí•œ ì—†ìŒ');
            }
            // ì‘ë‹µ ì‹œ ì„œë²„ê°€ ì²˜ë¦¬ í›„ ë°˜í™˜í•˜ì—¬ ìµœì‹  ì¹´ìš´íŠ¸ ë°ì´í„°ë¥¼ íŒŒì‹±í•¨
            const result = await response.json();
            // ë²„íŠ¼ ëˆ„ë¥¸ ê°’ í™”ë©´ì— ê°±ì‹ 
            updateLikeDislike(targetBtn, result.newLikeCount, result.newDislikeCount);
        } catch (error) {
            console.error('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', error);
            alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }


</script>
</body>
</html>