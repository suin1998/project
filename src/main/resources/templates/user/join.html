<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <link rel="stylesheet" href="../../static/css/join.css">
</head>
<body>
<main class="join">
    <div class="join-Box">
        <header class="logo">
            <h1>Logo</h1>
        </header>

        <div class="form-control">

            <label for="email">이메일</label>
            <div class="email-group">
                <input id="email" class="user_email" type="email" placeholder="email" required>
                <button id="requestVerifyBtn" class="btn btn-secondary" type="button">인증 요청</button>
            </div>

            <div id="codeInputArea" style="display:none;">
                <label for="verificationCode">인증 코드</label>
                <input id="verificationCode" type="text" placeholder="인증 코드를 입력하세요" maxlength="6">
                <button id="verifyCodeBtn" class="btn btn-secondary" type="button">인증 확인</button>
            </div>

            <label for="userId">아이디</label>
            <input id="userId" class="user_id" type="text" placeholder="user ID" required>

            <label for="nickname">닉네임</label>
            <input id="nickname" class="user_nickname" type="text" placeholder="nickname" required>

            <label for="password1">비밀번호</label>
            <input id="password1" class="password" type="password" placeholder="password" required>

            <label for="password2">비밀번호 확인</label>
            <input id="password2" class="password" type="password" placeholder="confirm password" required>

            <div class="birthForm">
                <label>생년월일</label>
                <div class="select-group">
                    <select id="birthYear" required>
                        <option value="">년</option>
                    </select>
                    <select id="birthMonth" required>
                        <option value="">월</option>
                    </select>
                    <select id="birthDay" required>
                        <option value="">일</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-gender">
            <input type="radio" id="gender1" name="gender" value="M" required>
            <label for="gender1" class="gender-card">남성</label>

            <input type="radio" id="gender2" name="gender" value="F" required>
            <label for="gender2" class="gender-card">여성</label>
        </div>

        <div class="joinBtn">
            <button class="btn btn-primary" type="button">가입하기</button>
        </div>
    </div>
</main>
</body>

<script>

    const CURRENT_YEAR = new Date().getFullYear();
    const START_YEAR = 1970;
    let isEmailVerified = false;

    const yearSelect = document.getElementById('birthYear');
    const monthSelect = document.getElementById('birthMonth');
    const daySelect = document.getElementById('birthDay');

    const requestVerifyBtn = document.getElementById('requestVerifyBtn');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const emailInput = document.getElementById('email');
    const codeInputArea = document.getElementById('codeInputArea');
    const verificationCodeInput = document.getElementById('verificationCode');

    function generateYearOptions() {
        for (let year = CURRENT_YEAR; year >= START_YEAR; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + '년';
            yearSelect.appendChild(option);
        }
    }

    function generateMonthOptions() {
        for (let month = 1; month <= 12; month++) {
            const option = document.createElement('option');
            const formattedMonth = String(month).padStart(2, '0');
            option.value = formattedMonth;
            option.textContent = month + '월';
            monthSelect.appendChild(option);
        }
    }

    function generateDayOptions() {
        daySelect.innerHTML = '<option value="">일</option>';
        const selectedYear = yearSelect.value;
        const selectedMonth = monthSelect.value;
        if (!selectedYear || !selectedMonth) return;

        const lastDay = new Date(selectedYear, selectedMonth, 0).getDate();

        for (let day = 1; day <= lastDay; day++) {
            const option = document.createElement('option');
            const formattedDay = String(day).padStart(2, '0');
            option.value = formattedDay;
            option.textContent = day + '일';
            daySelect.appendChild(option);
        }
    }

    requestVerifyBtn.addEventListener('click', function() {
        const email = emailInput.value;
        if (!email || !email.includes('@')) {
            alert('유효한 이메일 주소를 입력해주세요.');
            return;
        }

        fetch('/auth/send-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        })
            .then(response => {
                if (response.status === 200 || response.status === 202) {
                    alert('인증 코드가 이메일로 발송되었습니다. 코드를 입력해 주세요.');
                    codeInputArea.style.display = 'flex';
                    requestVerifyBtn.disabled = true;
                    emailInput.disabled = true;
                } else {
                    alert('인증 코드 발송에 실패했습니다. 이메일 주소를 다시 확인하거나, 이미 사용 중인 이메일일 수 있습니다.');
                }
            })
            .catch(error => {
                console.error('인증 요청 오류:', error);
                alert('네트워크 오류로 인증 요청에 실패했습니다.');
            });
    });

    verifyCodeBtn.addEventListener('click', function() {
        const email = emailInput.value;
        const code = verificationCodeInput.value;

        if (code.length === 0) {
            alert('인증 코드를 입력해주세요.');
            return;
        }

        fetch('/auth/verify-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, code: code})
        })
            .then(response => {
                if (response.ok) {
                    alert('이메일 인증이 완료되었습니다! 가입을 진행해 주세요.');
                    isEmailVerified = true;
                    verificationCodeInput.disabled = true;
                    verifyCodeBtn.disabled = true;
                } else {
                    alert('인증 코드가 일치하지 않거나 만료되었습니다. 다시 시도해주세요.');
                }
            })
            .catch(error => {
                console.error('인증 확인 오류:', error);
                alert('네트워크 오류로 인증 확인에 실패했습니다.');
            });
    });

    document.querySelector('.joinBtn .btn-primary').addEventListener('click', function() {

        const birthYear = yearSelect.value;
        const birthMonth = monthSelect.value;
        const birthDay = daySelect.value;

        const userId = document.getElementById('userId').value;
        const nickname = document.getElementById('nickname').value;
        const email = emailInput.value;
        const password = document.getElementById('password1').value;
        const passwordConfirm = document.getElementById('password2').value;
        const gender = document.querySelector('input[name="gender"]:checked');

        if (password !== passwordConfirm) {
            alert('비밀번호가 일치하지 않습니다. 다시 확인해주세요.');
            return;
        }

        if (!isEmailVerified) {
            alert('이메일 인증을 먼저 완료해주세요.');
            return;
        }

        if (!userId || !nickname || !email || !password || !gender || !birthYear || !birthMonth || !birthDay) {
            alert('모든 필수 정보를 입력해주세요.');
            return;
        }

        const currentYear = new Date().getFullYear();
        const age = currentYear - parseInt(birthYear);
        const userData = {
            userId: userId,
            password: password,
            email: email,
            nickname: nickname,
            gender: gender.value,
            age: age
        };

        fetch('/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
            .then(response => {
                if (response.ok) {
                    alert('회원가입이 완료되었습니다! 메인 화면으로 이동합니다.');
                    window.location.href = '/';
                } else if (response.status === 400) {
                    return response.text().then(text => {
                        alert('가입 실패: ' + (text || '입력 정보를 확인해주세요.'));
                    });
                } else {
                    alert('서버 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert('네트워크 연결 오류: 서버에 연결할 수 없습니다.');
            });
    });

    yearSelect.addEventListener('change', generateDayOptions);
    monthSelect.addEventListener('change', generateDayOptions);

    generateYearOptions();
    generateMonthOptions();

</script>
</html>