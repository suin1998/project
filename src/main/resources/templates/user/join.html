<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
    <link rel="stylesheet" href="/css/join.css">
</head>
<body>
<main class="join">
    <div class="join-Box">
        <header class="logo">
            <h1>회원가입</h1>
        </header>

        <p id="messageBox" role="alert"></p>

        <form id="joinForm">
            <div class="form-control">

                <label for="email">이메일</label>
                <div class="email-group">
                    <input id="email" class="user_email" type="email" placeholder="email" required>
                    <button id="requestVerifyBtn" class="btn btn-secondary" type="button">인증 요청</button>
                </div>

                <div id="codeInputArea" style="display:none;">
                    <label for="verificationCode">인증 코드</label>
                    <input id="verificationCode" type="text" placeholder="인증 코드를 입력하세요" maxlength="6">
                    <button id="verifyCodeBtn" class="btn btn-secondary" type="button">인증 확인</button>
                </div>

                <p id="codeVerifySuccess" class="messageBox success" style="display:none; margin-top: 10px;">
                    이메일 인증이 완료되었습니다!</p>

                <label for="userId">아이디</label>
                <input id="userId" class="user_id" type="text" placeholder="사용할 아이디" minlength="8" required
                       oninput="checkFormValidity()">
                <p id="idWarning" class="msg" style="display: none">아이디는 최소 4자 이상이어야 합니다.</p>
                <p id="idGapWarning" class="msg" style="display: none">공백이 포함될 수 없습니다.</p>

                <label for="nickname">닉네임</label>
                <input id="nickname" class="user_nickname" type="text" placeholder="닉네임" required
                       oninput="checkFormValidity()">
                <p id="nameWarning" class="msg" style="display: none">닉네임은 최소 4자 이상이어야 합니다.</p>
                <p id="nameGapWarning" class="msg" style="display: none">공백이 포함될 수 없습니다.</p>

                <label for="password1">비밀번호</label>
                <div class="password-check">
                    <input id="password1" class="password" type="password" placeholder="비밀번호(8자이상)" required
                           minlength="8" oninput="checkFormValidity()">
                    <button type="button" id="passwordCheckBtn" class="passwordBtn">
                        <i id="passwordIcon" class="far fa-eye"></i>
                    </button>
                </div>
                <p id="passwordMatchError2" class="msg" style="display: none;">비밀번호는 영어와 숫자를 모두 포함해야 합니다.</p>
                <p id="passwordMatchError3" class="msg" style="display: none;">비밀번호에는 한글을 포함할 수 없습니다.</p>
                <p id="passwordGapWarning" class="msg" style="display: none">공백이 포함될 수 없습니다.</p>

                <label for="password2">비밀번호 확인</label>
                <div class="password-check">
                    <input id="password2" class="password" type="password" placeholder="비밀번호 재확인" required
                           minlength="8" oninput="checkFormValidity()">
                    <button type="button" id="passwordCheckBtn2" class="passwordBtn">
                        <i id="passwordIcon2" class="far fa-eye"></i>
                    </button>
                </div>
                <p id="passwordMatchError" class="msg" style="display: none;">비밀번호가 일치하지 않습니다.</p>

                <div class="birthForm">
                    <label>생년월일</label>
                    <div class="select-group">
                        <select id="birthYear" required>
                            <option value="">년</option>
                        </select>
                        <select id="birthMonth" required>
                            <option value="">월</option>
                        </select>
                        <select id="birthDay" required>
                            <option value="">일</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-gender">
                <input type="radio" id="gender1" name="gender" value="M" required>
                <label for="gender1" class="gender-card">남성</label>

                <input type="radio" id="gender2" name="gender" value="F" required>
                <label for="gender2" class="gender-card">여성</label>
            </div>

            <div class="joinBtn">
                <button class="btn btn-primary" id="submitButton" type="button" disabled>가입하기</button>
            </div>
        </form>
    </div>
</main>
</body>

<script>

    // ========== 전역 변수 ==========
    let isEmailVerified = false;
    let verificationCode = '';

    // 딜레이를 줄이기 위한 저장할 변수들
    // let email, userId, nickname, password1, password2, birthYear, birthMonth, birthDay, gender, submitButton;

    const password = document.getElementById('password1').value;

    // ========== 페이지 로드 시 초기화 ==========
    document.addEventListener('DOMContentLoaded', function () {
        initializeDateSelects();
        attachEventListeners();
    });

    // ========== 날짜 Select 초기화 ==========
    function initializeDateSelects() {
        const yearSelect = document.getElementById('birthYear');
        const monthSelect = document.getElementById('birthMonth');
        const daySelect = document.getElementById('birthDay');

        // 연도 옵션 생성 (1970 ~ 현재)
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= 1970; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + '년';
            yearSelect.appendChild(option);
        }

        // 월 옵션 생성 (1 ~ 12)
        for (let month = 1; month <= 12; month++) {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month + '월';
            monthSelect.appendChild(option);
        }

        // 일 옵션 생성 (1 ~ 31)
        updateDayOptions();

        // 연도/월 변경 시 일 옵션 업데이트
        yearSelect.addEventListener('change', updateDayOptions);
        monthSelect.addEventListener('change', updateDayOptions);
    }

    // ========== 일자 옵션 동적 업데이트 ==========
    function updateDayOptions() {
        const yearSelect = document.getElementById('birthYear');
        const monthSelect = document.getElementById('birthMonth');
        const daySelect = document.getElementById('birthDay');

        const year = parseInt(yearSelect.value);
        const month = parseInt(monthSelect.value);

        // 현재 선택된 일 저장
        const currentDay = daySelect.value;

        // 일 옵션 초기화
        daySelect.innerHTML = '<option value="">일</option>';

        // 해당 월의 일수 계산
        let daysInMonth = 31;
        if (year && month) {
            daysInMonth = new Date(year, month, 0).getDate();
        }

        // 일 옵션 생성
        for (let day = 1; day <= daysInMonth; day++) {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day + '일';
            daySelect.appendChild(option);
        }

        // 이전 선택값 복원 (가능한 경우)
        if (currentDay && currentDay <= daysInMonth) {
            daySelect.value = currentDay;
        }
    }

    // ========== 이벤트 리스너 등록 ==========
    function attachEventListeners() {
        // 이메일 인증 요청 버튼
        document.getElementById('requestVerifyBtn').addEventListener('click', requestEmailVerification);

        // 인증 코드 확인 버튼
        document.getElementById('verifyCodeBtn').addEventListener('click', verifyEmailCode);

        // 비밀번호 확인 실시간 체크
        document.getElementById('password2').addEventListener('input', checkPasswordMatch);

        // 가입하기 버튼
        document.getElementById('submitButton').addEventListener('click', submitForm);

        // 모든 입력 필드에 유효성 검사 이벤트 추가
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('input', checkFormValidity);
            input.addEventListener('change', checkFormValidity);
        });
    }

    // ========== 이메일 인증 요청 ==========
    async function requestEmailVerification() {
        const email = document.getElementById('email').value.trim();

        if (!email) {
            showMessage('이메일을 입력해주세요.', 'error');
            return;
        }

        if (!validateEmail(email)) {
            showMessage('올바른 이메일 형식이 아닙니다.', 'error');
            return;
        }

        try {
            const response = await fetch('/auth/send-verification-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({email: email})
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showMessage('인증 코드가 이메일로 발송되었습니다.', 'success');
                document.getElementById('codeInputArea').style.display = 'block';
                document.getElementById('requestVerifyBtn').disabled = true;
                document.getElementById('requestVerifyBtn').textContent = '전송됨';
            } else {
                showMessage(data.message || '인증 코드 발송에 실패했습니다.', 'error');
            }
        } catch (error) {
            console.error('Email verification error:', error);
            showMessage('서버 연결에 실패했습니다.', 'error');
        }
    }

    // ========== 이메일 인증 코드 확인 ==========
    async function verifyEmailCode() {
        const email = document.getElementById('email').value.trim();
        const code = document.getElementById('verificationCode').value.trim();

        if (!code) {
            showMessage('인증 코드를 입력해주세요.', 'error');
            return;
        }

        try {
            const response = await fetch('/auth/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    code: code
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                isEmailVerified = true;
                showMessage('이메일 인증이 완료되었습니다!', 'success');
                document.getElementById('codeVerifySuccess').style.display = 'block';
                document.getElementById('codeInputArea').style.display = 'none';
                document.getElementById('email').readOnly = true;
                document.getElementById('verifyCodeBtn').disabled = true;
                checkFormValidity();
            } else {
                showMessage(data.message || '인증 코드가 올바르지 않습니다.', 'error');
            }
        } catch (error) {
            console.error('Code verification error:', error);
            showMessage('서버 연결에 실패했습니다.', 'error');
        }
    }

    // ========== 비밀번호 일치 확인 ==========
    function checkPasswordMatch() {
        const password1 = document.getElementById('password1').value;
        const password2 = document.getElementById('password2').value;
        const errorMsg = document.getElementById('passwordMatchError');

        if (password2 && password1 !== password2) {
            errorMsg.style.display = 'block';
            return false;
        } else {
            errorMsg.style.display = 'none';
            return true;
        }
    }

    // ============ 비밀번호 영어+숫자 필수, 영어와 숫자만 넣기(한글x) ============
    function validatePasswordFormat() {
        const password = document.getElementById('password1').value;
        const MatchErrorMsg = document.getElementById('passwordMatchError2');
        const koreaErrorMsg = document.getElementById('passwordMatchError3');
        const passwordGapWarning = document.getElementById('passwordGapWarning');

        const formatRegex = /^(?=.*[a-zA-Z])(?=.*[0-9])[a-zA-Z0-9]+$/;
        const koreanRegex = /[가-힣ㄱ-ㅎㅏ-ㅣ]/;
        const gap = /\s/;

        let isTure = true;

        if (password.length > 0 && gap.test(password)) {
            passwordGapWarning.style.display = "block";
            isTure = false;
        }
        if (password.length > 0 && koreanRegex.test(password)) {
            koreaErrorMsg.style.display = "block";
            isTure = false;
        }
        if(!isTure) {
            return false;
        }
        if (password.length > 0 && !formatRegex.test(password)) {
            MatchErrorMsg.style.display = "block";
            return false;
        }
        else {
            MatchErrorMsg.style.display = "none";
            koreaErrorMsg.style.display = "none";
            passwordGapWarning.style.display = "none";
            return true;
        }
    }

    // ============ 아이디 글자 수 확인 ============
    function checkId() {
        const userid = document.getElementById("userId").value;
        const idWarning = document.getElementById("idWarning");
        const idGapWarning = document.getElementById('idGapWarning');

        const gap = /\s/;

        if (userid.length > 0 && userid.length < 4) {
            idWarning.style.display = "block";
            return false;
        }
        if (gap.test(userid)) {
            idGapWarning.style.display = "block";
            return false;
        } else {
            idWarning.style.display = "none";
            idGapWarning.style.display = "none";
            return true;
        }
    }

    // ============ 닉네임 글자 수 확인 ============
    function checkNickname() {
        const nickname = document.getElementById('nickname').value;
        const nameWarning = document.getElementById('nameWarning');
        const nameGapWarning = document.getElementById('nameGapWarning');

        const gap = /\s/;

        if (nickname.length > 0 && nickname.length < 4) {
            nameWarning.style.display = "block";
            return false;
        }
        if (gap.test(nickname)) {
            nameGapWarning.style.display = "block";
            return false;
        } else {
            nameWarning.style.display = "none";
            nameGapWarning.style.display = "none";
            return true;
        }
    }

    // ========== 폼 유효성 검사 ==========
    function checkFormValidity() {
        const email = document.getElementById('email').value;
        const userId = document.getElementById('userId').value;
        const nickname = document.getElementById('nickname').value;
        const password1 = document.getElementById('password1').value;
        const password2 = document.getElementById('password2').value;
        const birthYear = document.getElementById('birthYear').value;
        const birthMonth = document.getElementById('birthMonth').value;
        const birthDay = document.getElementById('birthDay').value;
        const gender = document.querySelector('input[name="gender"]:checked');

        const submitButton = document.getElementById('submitButton');

        const isIdValid = checkId();
        const isNicknameValid = checkNickname();
        const isPasswordFormat = validatePasswordFormat();

        const allFieldsFilled =
            email &&
            userId &&
            nickname &&
            password1.length >= 8 &&
            password2.length >= 8 &&
            birthYear &&
            birthMonth &&
            birthDay &&
            gender &&
            isEmailVerified &&
            isIdValid &&
            isNicknameValid &&
            isPasswordFormat;

        // 비밀번호 일치 확인
        const passwordsMatch = password1 === password2;

        // 버튼 활성화/비활성화
        if (allFieldsFilled && passwordsMatch) {
            submitButton.disabled = false;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
        } else {
            submitButton.disabled = true;
            submitButton.style.opacity = '0.5';
            submitButton.style.cursor = 'not-allowed';
        }
    }

    // ========== 회원가입 제출 ==========
    async function submitForm() {
        // 최종 유효성 검사
        if (!isEmailVerified) {
            showMessage('이메일 인증을 완료해주세요.', 'error');
            return;
        }

        if (!checkPasswordMatch()) {
            showMessage('비밀번호가 일치하지 않습니다.', 'error');
            return;
        }

        // 폼 데이터 수집
        const email = document.getElementById('email').value;
        const username = document.getElementById('userId').value;
        const nickname = document.getElementById('nickname').value;
        const password = document.getElementById('password1').value;
        const confirmPassword = document.getElementById('password2').value;

        const birthYear = document.getElementById('birthYear').value;
        const birthMonth = document.getElementById('birthMonth').value.padStart(2, '0');
        const birthDay = document.getElementById('birthDay').value.padStart(2, '0');
        const birthDate = `${birthYear}-${birthMonth}-${birthDay}`;

        const genderElement = document.querySelector('input[name="gender"]:checked');
        const gender = genderElement.value === 'M' ? 'MALE' : 'FEMALE';

        // 회원가입 요청 데이터
        const signupData = {
            username: username,
            email: email,
            nickname: nickname,
            password: password,
            confirmPassword: confirmPassword,
            birthDate: birthDate,
            gender: gender
        };

        console.log('Signup data:', signupData);

        // 버튼 비활성화 (중복 제출 방지)
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.textContent = '가입 중...';

        try {
            const response = await fetch('/auth/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(signupData)
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showMessage('회원가입이 완료되었습니다. 환영합니다!', 'success');

                // 토큰 저장
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                }

                // 2초 후 로그인 페이지로 이동
                // setTimeout(() => {
                //     window.location.href = '/';
                // }, 2000);

                window.location.href = '/';

            } else {
                // 에러 메시지 표시
                if (data.validationErrors && data.validationErrors.length > 0) {
                    const errors = data.validationErrors.map(err => err.message).join('\n');
                    showMessage(errors, 'error');
                } else {
                    showMessage(data.message || '회원가입에 실패했습니다.', 'error');
                }

                // 버튼 다시 활성화
                submitButton.disabled = false;
                submitButton.textContent = '가입하기';
            }

        } catch (error) {
            console.error('Signup error:', error);
            showMessage('서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.', 'error');

            // 버튼 다시 활성화
            submitButton.disabled = false;
            submitButton.textContent = '가입하기';
        }
    }

    // ========== 메시지 표시 함수 ==========
    function showMessage(message, type) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        messageBox.style.padding = '10px';
        messageBox.style.marginBottom = '15px';
        messageBox.style.borderRadius = '5px';
        messageBox.style.fontSize = '14px';
        messageBox.style.fontWeight = '500';

        if (type === 'success') {
            messageBox.style.backgroundColor = '#d4edda';
            messageBox.style.color = '#155724';
            messageBox.style.border = '1px solid #c3e6cb';
        } else if (type === 'error') {
            messageBox.style.backgroundColor = '#f8d7da';
            messageBox.style.color = '#721c24';
            messageBox.style.border = '1px solid #f5c6cb';
        }

        // 3초 후 자동 숨김
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 3000);
    }

    // ========== 이메일 유효성 검사 ==========
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // 비밀번호 보이게 하기 (다시 숨기기도)
    document.addEventListener('DOMContentLoaded', function () {
        const password = document.getElementById('password1');
        const password2 = document.getElementById('password2');
        const passwordCheck = document.getElementById('passwordCheckBtn');
        const passwordCheck2 = document.getElementById('passwordCheckBtn2');

        passwordCheck.addEventListener('click', function() {
            const passwordType = password.getAttribute('type');

            if (passwordType === 'password') {
                password.setAttribute('type', 'text');
                document.getElementById("passwordCheckBtn").innerHTML = "<i class=\"far fa-eye-slash\"></i>";
            } else {
                password.setAttribute('type', 'password');
                document.getElementById("passwordCheckBtn").innerHTML = "<i class=\"far fa-eye\"></i>";
            }
        });

        passwordCheck2.addEventListener('click', function() {
            const passwordType2 = password2.getAttribute('type');

            if (passwordType2 === 'password') {
                password2.setAttribute('type', 'text');
                document.getElementById("passwordCheckBtn2").innerHTML = "<i class=\"far fa-eye-slash\"></i>";
            } else {
                password2.setAttribute('type', 'password');
                document.getElementById("passwordCheckBtn2").innerHTML = "<i class=\"far fa-eye\"></i>";
            }
        });
    });
</script>

</html>