<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/css/login.css">
</head>
<body>
<main class="login">
    <form>
        <div class="login-Box">
            <header class="logo">
                <h1>Fit Maker</h1>
            </header>

            <div class="form-control">
                <label for="email">ì´ë©”ì¼</label>
                <input id="email" class="user_email" type="email" placeholder="email">

                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input id="password" class="password" type="password" placeholder="password">

                <div class="loginBtn">
                    <button class="btn btn-primary" id="loginSubmitBtn" type="submit">ë¡œê·¸ì¸</button>

                    <button class="btn btn-outline" id="signupBtn" type="button">íšŒì›ê°€ì…</button>

                </div>
            </div>
        </div>
    </form>
</main>
<script>
    // ========== ì „ì—­ ë³€ìˆ˜ ==========
    const LOGIN_API_URL = '/auth/login';
    const REDIRECT_PARAM_NAME = 'redirectTo';// Spring Boot ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸

    document.addEventListener('DOMContentLoaded', function () {
        // ğŸ’¡ 1. URLì—ì„œ 'redirectTo' íŒŒë¼ë¯¸í„°ë¥¼ ì½ì–´ localStorageì— ì €ì¥
        const urlParams = new URLSearchParams(window.location.search);
        const redirectTo = urlParams.get(REDIRECT_PARAM_NAME) || '/'; // ì—†ìœ¼ë©´ '/'ë¡œ ê¸°ë³¸ê°’ ì„¤ì •

        // localStorageì— ì €ì¥
        localStorage.setItem(REDIRECT_PARAM_NAME, redirectTo);

        attachEventListeners();
    });

    // ========== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ==========
    function attachEventListeners() {
        document.getElementById('loginSubmitBtn').addEventListener('click', handleLogin);
        document.getElementById('signupBtn').addEventListener('click', redirectToSignup);
    }

    // ========== ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜ ==========
    async function handleLogin() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const loginButton = document.getElementById('loginSubmitBtn');

        const storedRedirectPath = localStorage.getItem(REDIRECT_PARAM_NAME) || '/';

        if (!email || !password) {
            alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ì œì¶œ ë°©ì§€)
        loginButton.disabled = true;
        loginButton.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

        try {
            const response = await fetch(LOGIN_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: email,
                    password: password
                })
            });

            const data = await response.json();

            if (response.ok) {
                // 1. ë¡œê·¸ì¸ ì„±ê³µ
                // alert('ë¡œê·¸ì¸ ì„±ê³µ!');

                // 2. í† í° ì €ì¥ (AuthResponseDTOì— í¬í•¨ëœ í† í°ì„ localStorageì— ì €ì¥)
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                }

                // 3. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                localStorage.removeItem(REDIRECT_PARAM_NAME);
                window.location.href = storedRedirectPath; // ë©”ì¸ í˜ì´ì§€ ê²½ë¡œ (ë£¨íŠ¸)

            } else {
                // 4. ë¡œê·¸ì¸ ì‹¤íŒ¨ (ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ í‘œì‹œ)
                alert(data.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');

                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                loginButton.disabled = false;
                loginButton.textContent = 'ë¡œê·¸ì¸';
            }

        } catch (error) {
            console.error('Login error:', error);
            alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

            // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            loginButton.disabled = false;
            loginButton.textContent = 'ë¡œê·¸ì¸';
        }
    }

    // ========== íšŒì›ê°€ì… í˜ì´ì§€ ì´ë™ í•¨ìˆ˜ ==========
    function redirectToSignup() {
        window.location.href = '/join'; // íšŒì›ê°€ì… í˜ì´ì§€ ê²½ë¡œ
    }
</script>
</body>
</html>