<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Closet</title>
    <link rel="stylesheet" href="/css/myCloset.css">
</head>
<body>
<!--í—¤ë” ê´€ë ¨ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.-->
<header>
    <div class="logo">Fit Maker<button id="logoMain"></button>
    </div>
    <nav>
        <div class="headerBtn">
            <a href="/logout" id="logoutLink">Logout</a>
            <button id="AICoordinatorButton">AI Coordinator</button>
        </div>
    </nav>
</header>

<div class="container">

    <!-- ---------------- Dashboard: Calendar + Profile ---------------- -->
    <div class="container-dashboard">
        <section class="dashboard">
            <div class="calendar-card">
                <div class="calendar-header">
                    <button id="prev"><</button>
                    <h3 id="monthYear"></h3>
                    <button id="next">></button>
                </div>
                <table id="calendar">
                    <thead>
                    <tr>
                        <th>Sun</th><th>Mon</th><th>Tue</th>
                        <th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                    </tr>
                    </thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>
        </section>

        <section class="profile">
            <div class="profile-card">
                <div class="profile-img">
                    <img src="/image/user/user-img.jpg" alt="">
                </div>
                <div class="profile-text">
                    <h3 id="user-name">000ë‹˜ ì•ˆë…•í•˜ì„¸ìš”</h3>
                    <a href="#" id="profile-edit">ì •ë³´ìˆ˜ì •</a>
                </div>
            </div>
        </section>
    </div>

    <!-- ---------------- Category + Closet Images ---------------- -->
    <div class="container-editors">

        <!-- CATEGORY LEFT SIDEBAR -->
        <div class="tag-list" id="categoryList">
            <!-- ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì¹´í…Œê³ ë¦¬ ìë™ ìƒì„±ë¨ -->
        </div>

        <!-- IMAGE AREA -->
        <div class="image-area">
            <input type="file" id="img-upload">
            <label for="img-upload">ì‚¬ì§„ ì €ì¥í•˜ê¸°</label>

            <div id="imageCount"></div>

            <div id="closetContainer" class="image-grid">
                <!-- ì˜· ì´ë¯¸ì§€ ìë™ ë¡œë“œ -->
            </div>
        </div>
    </div>

    <!-- ---------------- Tag Search ---------------- -->
    <div class="image-area" style="margin-top:30px;">
        <h2>íƒœê·¸ ê²€ìƒ‰</h2>
        <input type="text" id="searchTags" class="form-box" placeholder="ê²€ìƒ‰ íƒœê·¸ ì…ë ¥ (ì½¤ë§ˆ êµ¬ë¶„)">
        <button class="submit-btn" onclick="searchByTags()">ê²€ìƒ‰</button>

        <div id="searchResults" class="image-grid" style="margin-top:20px;"></div>
    </div>
</div>

<script>
    const apiBase = "/api/closet";

    // í—¤ë” ê´€ë ¨ìœ¼ë¡œ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.
    // í˜ì´ì§€ ì´ë™ ê´€ë ¨ (ë¡œê³  í´ë¦­ ì‹œ ë©”ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.)
    // const accessToken = localStorage.getItem('accessToken');

    function getAuthHeaders() {

        const currentAccessToken = localStorage.getItem('accessToken');

        if (!currentAccessToken) {
            // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login?redirectTo=/myCloset';
            throw new Error('No Access Token found.');
        }
        return {
            'Authorization': `Bearer ${currentAccessToken}`,
            'Content-Type': 'application/json' // POST/PUT ìš”ì²­ ì‹œ í•„ìš”
        };
    }

    async function loadClosetData(category) {
        // try-catch ë¸”ë¡ ì¶”ê°€í•˜ì—¬ 401 ì—ëŸ¬ ì²˜ë¦¬
        try {
            const headers = getAuthHeaders(); // ğŸ’¡ í—¤ë” ê°€ì ¸ì˜¤ê¸°

            const res = await fetch(`${apiBase}/grouped?category=${category}`, {
                method: 'GET',
                headers: headers // ğŸ’¡ í—¤ë” ì ìš©
            });

            if (res.status === 401) {
                // 401 ì—ëŸ¬ ë°œìƒ ì‹œ ì¬ë¡œê·¸ì¸ ìœ ë„
                alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/login?redirectTo=/myCloset';
                return;
            }

            if (!res.ok) {
                throw new Error(`Failed to fetch closet data: ${res.status}`);
            }

            const data = await res.json();
            // dataëŠ” {TOP: [...], BOTTOM: [...], ...} í˜•íƒœì¼ ê²ƒìœ¼ë¡œ ì˜ˆìƒ
            renderCloset(data[category.toUpperCase()] || [], category);

        } catch (error) {
            console.error("Error loading closet data:", error);
            // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ ë‹¤ë¥¸ ë¬¸ì œ ë°œìƒ ì‹œ
        }
    }

    function redirectToAICoordinator() {
        window.location.href = '/AICoordinator';
    }

    function redirectToMain() {
        window.location.href = '/';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', handleLogout);
        }

        const AICoordinatorButton = document.getElementById('AICoordinatorButton');
        if (AICoordinatorButton) {
            AICoordinatorButton.addEventListener('click', redirectToAICoordinator);
        }

        const logoMainButton = document.getElementById('logoMain');
        if(logoMainButton) {
            logoMainButton.addEventListener('click', redirectToMain);
        }

    });

    function handleLogout(event) {
        event.preventDefault(); // <a> íƒœê·¸ì˜ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ì´ë™) ë°©ì§€

        localStorage.removeItem('accessToken');

        // ë¡œê·¸ì•„ì›ƒ ì‹œ, ë©”ì¸ìœ¼ë¡œ ê°€ê¸°
        window.location.href = '/';
    }

    document.addEventListener("DOMContentLoaded", () => {
        const logout = document.getElementById("logout");
        const main = document.getElementById("main");
        const AICoordinator = document.getElementById("AICoordinator");

        if (logout) {
            logout.addEventListener("click", (e) => {
                e.preventDefault();
                localStorage.removeItem("accessToken");
                localStorage.removeItem("refreshToken");
                alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "/";
            });
        }

        if (main) {
            main.addEventListener("click", (e) => {
                e.preventDefault();
                window.location.href = "/";
            });
        }

        if (AICoordinator) {
            AICoordinator.addEventListener("click", (e) => {
                e.preventDefault();
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                } else {
                    window.location.href = '/AICoordinator';
                }
            });
        }
    });


    /* ---------------------------- ë‹¬ë ¥ ë Œë”ë§ ---------------------------- */
    document.addEventListener("DOMContentLoaded", () => {

        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        const monthYear = document.getElementById("monthYear");
        const calendarBody = document.getElementById("calendarBody");

        function renderCalendar() {
            calendarBody.innerHTML = "";

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

            monthYear.textContent = `${currentYear}ë…„ ${currentMonth + 1}ì›”`;

            let row = document.createElement("tr");

            for (let i = 0; i < firstDay; i++) {
                row.appendChild(document.createElement("td"));
            }

            for (let day = 1; day <= lastDate; day++) {
                if (row.children.length === 7) {
                    calendarBody.appendChild(row);
                    row = document.createElement("tr");
                }

                const cell = document.createElement("td");
                cell.textContent = day;

                if (
                    currentYear === today.getFullYear() &&
                    currentMonth === today.getMonth() &&
                    day === today.getDate()
                ) {
                    cell.classList.add("today");
                }

                row.appendChild(cell);
            }

            calendarBody.appendChild(row);
        }

        document.getElementById("prev").addEventListener("click", () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        document.getElementById("next").addEventListener("click", () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        renderCalendar();
    });

    /* ---------------------------- ì˜· ë“±ë¡ ê¸°ëŠ¥ ---------------------------- */
    const imgInput = document.getElementById("img-upload");

    imgInput.addEventListener("change", handleImageUpload);

    async function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const selectedRadio = document.querySelector("input[name='category']:checked");
        if (!selectedRadio) {
            alert("ë¨¼ì € ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            imgInput.value = "";
            return;
        }

        const category = selectedRadio.value; // ex) "TOP", "BOTTOM" ë“±
        const accessToken = localStorage.getItem('accessToken');

        const dto = {
            userId: "",              // ì„œë²„ì—ì„œ principalë¡œ ì„¸íŒ…í•˜ë‹ˆ ì—¬ê¸°ì„œëŠ” ë¹„ì›Œë„ ë˜ê¸´ í•¨
            category: category,
            imageUrl: null,          // íŒŒì¼ ì—…ë¡œë“œ ë°©ì‹ì´ë¯€ë¡œ URLì€ ì„œë²„ê°€ ì±„ì›€
            brand: null,             // ë‚˜ì¤‘ì— ë¸Œëœë“œ ì…ë ¥ í¼ ë§Œë“¤ë©´ ê°’ ì±„ìš°ê¸°
            tags: []                 // ë‚˜ì¤‘ì— íƒœê·¸ ì…ë ¥ í¼ ë§Œë“¤ë©´ ê°’ ì±„ìš°ê¸°
        };

        const formData = new FormData();
        formData.append(
            "data",
            new Blob([JSON.stringify(dto)], { type: "application/json" })
        );
        formData.append("image", file);

        const res = await fetch(`${apiBase}`, {
            method: "POST",
            headers: {
                'Authorization': accessToken ? `Bearer ${accessToken}` : ''
            },
            body: formData
        });

        if (!res.ok) {
            if (res.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        const saved = await res.json();
        alert("ì˜·ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");

        // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìƒˆë¡œê³ ì¹¨
        await loadCloset(category);

        // íŒŒì¼ input ì´ˆê¸°í™”
        imgInput.value = "";
    }


    /* ---------------------------- ì¹´í…Œê³ ë¦¬ ìë™ ë¡œë”© ---------------------------- */
    async function loadCategories() {
        const res = await fetch(`${apiBase}/categories`);
        const categories = await res.json();

        const categoryList = document.getElementById("categoryList");

        categories.forEach((c, idx) => {
            const id = "cat" + idx;

            const radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "category";
            radio.id = id;
            radio.value = c.code;
            if (idx === 0) radio.checked = true;
            radio.addEventListener("change", () => loadCloset(c.code));

            const label = document.createElement("label");
            label.className = "btn";
            label.setAttribute("for", id);
            label.textContent = c.label;

            categoryList.appendChild(radio);
            categoryList.appendChild(label);
        });

        // ì¹´í…Œê³ ë¦¬ ë¡œë”©ì´ ëë‚œ í›„ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ ë¡œë”©
        if (categories.length > 0) {
            await loadCloset(categories[0].code);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // ...
        loadCategories();
    });


    /* ---------------------------- ì˜· ëª©ë¡ ë¡œë”© ---------------------------- */
    const closetContainer = document.getElementById("closetContainer");
    const imageCount = document.getElementById("imageCount");

    async function loadCloset(category) {
        const accessToken = localStorage.getItem('accessToken');

        const res = await fetch(`${apiBase}/category/${category}`, {
            headers: {
                'Authorization': accessToken ? `Bearer ${accessToken}` : ''
            }
        });

        if (!res.ok) {
            if (res.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }
            alert('ì˜·ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return;
        }

        const items = await res.json();
        renderCloset(items, category);
    }

    function renderCloset(items, category) {
        closetContainer.innerHTML = "";

        items.forEach(item => {
            const img = document.createElement("img");
            img.src = item.imageUrl;
            img.alt = category;
            img.loading = "lazy";
            closetContainer.appendChild(img);
        });

        imageCount.textContent = `${category} ${items.length}ê°œ`;
    }

    /* ---------------------------- íƒœê·¸ ê²€ìƒ‰ ---------------------------- */
    async function searchByTags() {
        const tags = document.getElementById("searchTags").value
            .split(",")
            .map(v => v.trim())
            .filter(v => v.length > 0);

        if (tags.length === 0) {
            alert('íƒœê·¸ë¥¼ 1ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const params = new URLSearchParams();
        tags.forEach(t => params.append("tags", t));

        const accessToken = localStorage.getItem('accessToken');

        const res = await fetch(`${apiBase}/search/tags?${params.toString()}`, {
            headers: {
                'Authorization': accessToken ? `Bearer ${accessToken}` : ''
            }
        });

        if (!res.ok) {
            if (res.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }
            alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            return;
        }

        // const list = await res.json();
        // const container = document.getElementById("searchResults");
        // container.innerHTML = "";
        //
        //     const list = await res.json();
        //
        //     // ... (ë‚˜ë¨¸ì§€ ë Œë”ë§ ë¡œì§)
        //
        // } catch (error) {
        //     console.error("Error searching by tags:", error);
        // }
    }


</script>

</body>
</html>
