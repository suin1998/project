<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Closet</title>
    <link rel="stylesheet" href="/css/myCloset.css">
</head>
<body>
<!--헤더 관련 수정했습니다.-->
<header>
    <div class="logo"><a href="/">Fit Maker</a>
    </div>
    <div class="movementPage">
        <a href="/myCloset">My Closet</a>
        <a href="/AICoordinator">AI Coordinator</a>
        <a href="/community">Community</a>
    </div>
    <nav>
        <div class="headerBtn">
            <a href="/logout" id="logoutLink">Logout</a>
            <a href="/myPage">My Page</a>
            <!--            <button id="MyClosetButton">My Closet</button>-->
        </div>
    </nav>
</header>

<div class="container">

    <!-- ---------------- Dashboard: Calendar + Profile ---------------- -->
    <div class="container-dashboard">
        <section class="dashboard">
            <div class="calendar-card">
                <div class="calendar-header">
                    <button id="prev"><</button>
                    <h3 id="monthYear"></h3>
                    <button id="next">></button>
                </div>
                <table id="calendar">
                    <thead>
                    <tr>
                        <th>Sun</th><th>Mon</th><th>Tue</th>
                        <th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                    </tr>
                    </thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>
        </section>

        <section class="profile">
            <div class="profile-card">
                <div class="profile-img">
                    <img src="/image/user/user-img.jpg" alt="">
                </div>
                <div class="profile-text">
                    <h3 id="user-name">000님 안녕하세요</h3>
                    <a href="/myPage" id="profile-edit">정보수정</a>
                </div>
            </div>
        </section>
    </div>

    <!-- ---------------- Category + Closet Images ---------------- -->
    <div class="container-editors">

        <!-- CATEGORY LEFT SIDEBAR -->
        <div class="tag-list" id="categoryList">
            <!-- 서버에서 가져온 카테고리 자동 생성됨 -->
        </div>

        <!-- IMAGE AREA -->
        <div class="image-area">
            <input type="file" id="img-upload">
            <label for="img-upload">사진 저장하기</label>

            <div id="imageCount"></div>

            <div id="closetContainer" class="image-grid">
                <!-- 옷 이미지 자동 로드 -->
            </div>
        </div>
    </div>

</div>

<script>
    const apiBase = "/api/closet";

    const closetContainer = document.getElementById("closetContainer");
    const imageCount = document.getElementById("imageCount");

    /* ---------------------------- 공통 이동 함수 ---------------------------- */
    function redirectToAICoordinator() {
        window.location.href = '/AICoordinator';
    }

    function redirectToMain() {
        window.location.href = '/';
    }

    function handleLogout(event) {
        event.preventDefault(); // <a> 기본 이동 막기
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        alert("로그아웃되었습니다.");
        window.location.href = '/';
    }

    /* ---------------------------- DOMContentLoaded ---------------------------- */
    document.addEventListener("DOMContentLoaded", () => {
        // 헤더 버튼 이벤트 연결
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', handleLogout);
        }

        const AICoordinatorButton = document.getElementById('AICoordinatorButton');
        if (AICoordinatorButton) {
            AICoordinatorButton.addEventListener('click', redirectToAICoordinator);
        }

        const logoMainButton = document.getElementById('logoMain');
        if (logoMainButton) {
            logoMainButton.addEventListener('click', redirectToMain);
        }

        // 달력 렌더링 초기화
        initCalendar();

        // 카테고리 & 옷장 초기 로딩
        loadCategories();

        // 이미지 업로드 이벤트 연결
        const imgInput = document.getElementById("img-upload");
        if (imgInput) {
            imgInput.addEventListener("change", handleImageUpload);
        }
    });

    /* ---------------------------- 달력 렌더링 ---------------------------- */
    function initCalendar() {
        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        const monthYear = document.getElementById("monthYear");
        const calendarBody = document.getElementById("calendarBody");

        function renderCalendar() {
            calendarBody.innerHTML = "";

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

            monthYear.textContent = `${currentYear}년 ${currentMonth + 1}월`;

            let row = document.createElement("tr");

            for (let i = 0; i < firstDay; i++) {
                row.appendChild(document.createElement("td"));
            }

            for (let day = 1; day <= lastDate; day++) {
                if (row.children.length === 7) {
                    calendarBody.appendChild(row);
                    row = document.createElement("tr");
                }

                const cell = document.createElement("td");
                cell.textContent = String(day);

                if (
                    currentYear === today.getFullYear() &&
                    currentMonth === today.getMonth() &&
                    day === today.getDate()
                ) {
                    cell.classList.add("today");
                }

                row.appendChild(cell);
            }

            calendarBody.appendChild(row);
        }

        document.getElementById("prev").addEventListener("click", () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        document.getElementById("next").addEventListener("click", () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        renderCalendar();
    }

    /* ---------------------------- 카테고리 자동 로딩 ---------------------------- */
    async function loadCategories() {
        const res = await fetch(`${apiBase}/categories`);
        if (!res.ok) {
            alert("카테고리 정보를 불러오지 못했습니다.");
            return;
        }

        const categories = await res.json();
        const categoryList = document.getElementById("categoryList");
        categoryList.innerHTML = "";

        categories.forEach((c, idx) => {
            const id = "cat" + idx;

            const radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "category";
            radio.id = id;
            radio.value = c.code;
            if (idx === 0) radio.checked = true;
            radio.addEventListener("change", () => loadCloset(c.code));

            const label = document.createElement("label");
            label.className = "btn";
            label.setAttribute("for", id);
            label.textContent = c.label;

            categoryList.appendChild(radio);
            categoryList.appendChild(label);
        });

        // 카테고리 로딩이 끝난 후 첫 번째 카테고리 로딩
        if (categories.length > 0) {
            await loadCloset(categories[0].code);
        }
    }

    /* ---------------------------- 옷 목록 로딩 ---------------------------- */
    async function loadCloset(category) {
        const accessToken = localStorage.getItem('accessToken');

        const res = await fetch(`${apiBase}/category/${category}`, {
            headers: {
                'Authorization': accessToken ? `Bearer ${accessToken}` : ''
            }
        });

        if (!res.ok) {
            if (res.status === 401) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }
            alert('옷장 데이터를 불러오지 못했습니다.');
            return;
        }

        const items = await res.json();
        renderCloset(items, category);
    }

    function renderCloset(items, category) {
        closetContainer.innerHTML = "";

        items.forEach(item => {
            const img = document.createElement("img");
            img.src = item.imageUrl;
            img.alt = category;
            img.loading = "lazy";
            closetContainer.appendChild(img);
        });

        imageCount.textContent = `${category} ${items.length}개`;
    }

    /* ---------------------------- 이미지 업로드 → 옷 등록 ---------------------------- */
    async function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // 현재 선택된 카테고리
        const selectedRadio = document.querySelector("input[name='category']:checked");
        if (!selectedRadio) {
            alert("먼저 카테고리를 선택해주세요.");
            event.target.value = "";
            return;
        }

        const category = selectedRadio.value; // (ex) "TOP", "BOTTOM"
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
            alert("로그인이 필요합니다.");
            window.location.href = '/login';
            return;
        }

        // 백엔드 ClosetRequestDTO에 맞춰서 DTO 구성 (카테고리만)
        const dto = {
            category: category
        };

        const formData = new FormData();
        formData.append(
            "data",
            new Blob([JSON.stringify(dto)], { type: "application/json" })
        );
        formData.append("image", file);

        const res = await fetch(`${apiBase}`, {
            method: "POST",
            headers: {
                'Authorization': `Bearer ${accessToken}`
                // Content-Type은 FormData가 자동으로 설정하므로 지정하지 않음
            },
            body: formData
        });

        if (!res.ok) {
            if (res.status === 401) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }
            alert("이미지 업로드에 실패했습니다.");
            return;
        }

        const saved = await res.json();
        console.log(saved); // 임시 확인용
        alert("옷이 등록되었습니다!");

        // 현재 카테고리 다시 로딩
        await loadCloset(category);

        // 파일 input 초기화
        event.target.value = "";
    }

</script>

</body>
</html>
